"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.sanitizeRedirectUrl = void 0;
var shopify_api_1 = require("@shopify/shopify-api");
var FILE_URI_MATCH = /\/\/\//;
var INVALID_RELATIVE_URL = /[/\\][/\\]/;
var WHITESPACE_CHARACTER = /\s/;
var VALID_PROTOCOLS = ['https:', 'http:'];
function isSafe(domain, redirectUrl, requireSSL) {
    if (requireSSL === void 0) { requireSSL = true; }
    if (typeof redirectUrl !== 'string') {
        return false;
    }
    if (FILE_URI_MATCH.test(redirectUrl) ||
        WHITESPACE_CHARACTER.test(redirectUrl)) {
        return false;
    }
    var url;
    try {
        url = new URL(redirectUrl, domain);
    }
    catch (error) {
        return false;
    }
    if (INVALID_RELATIVE_URL.test(url.pathname)) {
        return false;
    }
    if (!VALID_PROTOCOLS.includes(url.protocol)) {
        return false;
    }
    if (requireSSL && url.protocol !== 'https:') {
        return false;
    }
    return true;
}
function sanitizeRedirectUrl(domain, redirectUrl, options) {
    if (options === void 0) { options = {}; }
    if (isSafe(domain, redirectUrl, options.requireSSL)) {
        return new URL(redirectUrl, domain);
    }
    else if (options.throwOnInvalid === false) {
        return undefined;
    }
    else {
        throw new shopify_api_1.ShopifyError('Invalid URL. Refusing to redirect');
    }
}
exports.sanitizeRedirectUrl = sanitizeRedirectUrl;
//# sourceMappingURL=validate-redirect-url.js.map